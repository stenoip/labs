<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Enhanced VR World</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- A-Frame -->
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <script src="https://unpkg.com/aframe-environment-component@1.3.3/dist/aframe-environment-component.min.js"></script>

  <style>
    html, body {
      margin: 0;
      height: 100%;
      background: #000;
      font-family: system-ui, sans-serif;
    }
  </style>
</head>

<body>
<a-scene renderer="antialias: true" fog="type: exponential; density: 0.06; color: #0a0f1a">

  <!-- Sky -->
  <a-sky color="#0a0f1a"></a-sky>

  <!-- Lights -->
  <a-entity light="type: ambient; color: #889"></a-entity>
  <a-entity light="type: directional; color: #fff; intensity: 0.7" position="2 4 2"></a-entity>

  <!-- Environment -->
  <a-entity environment="preset: forest; skyType: gradient; dressing: trees; dressingAmount: 25; ground: hills; groundColor: #234; groundColor2: #112"></a-entity>

  <!-- Moving clouds -->
  <a-plane position="0 20 0" rotation="-90 0 0" width="200" height="200"
           material="src: https://cdn.aframe.io/a-painter/images/floor.jpg; opacity: 0.15"
           animation="property: position; to: 0 20 -40; dur: 30000; loop: true">
  </a-plane>

  <!-- Fireflies -->
  <a-entity id="fireflies"></a-entity>

  <!-- Interactive objects -->
  <a-box id="box1" position="0 1.25 -3" depth="1" height="1" width="1"
         color="#4CC3D9" shadow class="clickable react">
  </a-box>

  <a-sphere id="sphere1" position="2 1.5 -4" radius="1"
            color="#EF2D5E" shadow class="clickable react">
  </a-sphere>

  <a-cylinder id="cyl1" position="-2 1 -2.5" radius="0.5" height="2"
              color="#FFC65D" shadow class="clickable react">
  </a-cylinder>

  <!-- Magical crystal -->
  <a-octahedron position="0 2 -6" radius="1" color="#66ccff"
                animation__pulse="property: scale; dir: alternate; to: 1.3 1.3 1.3; dur: 2000; loop: true"
                animation__glow="property: material.emissiveIntensity; dir: alternate; to: 1.5; dur: 1500; loop: true">
  </a-octahedron>

  <!-- Ground -->
  <a-plane position="0 0 -4" rotation="-90 0 0" width="30" height="30" color="#1a2633" shadow></a-plane>

  <!-- Player rig -->
  <a-entity id="rig" position="0 1.6 0">
    <a-camera wasd-controls="acceleration: 25" look-controls="pointerLockEnabled: true">
      <a-cursor fuse="true" fuse-timeout="600" material="color: #fff; shader: flat"></a-cursor>
    </a-camera>
  </a-entity>

  <!-- Controllers -->
  <a-entity laser-controls="hand: left" raycaster="objects: .clickable"></a-entity>
  <a-entity laser-controls="hand: right" raycaster="objects: .clickable"></a-entity>

  <!-- Minimap orb -->
  <a-sphere id="minimap" position="0 4 0" radius="0.3" color="#00ffff"
            material="opacity: 0.7; emissive: #0ff; emissiveIntensity: 1">
  </a-sphere>

  <!-- Scripts -->
  <script>
    /* CLICK BEHAVIOR */
    AFRAME.registerComponent('click-behavior', {
      init: function () {
        this.el.addEventListener('click', () => {
          const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0');
          this.el.setAttribute('color', randomColor);

          this.el.setAttribute('animation__bounce', {
            property: 'position',
            to: `${this.el.object3D.position.x} ${this.el.object3D.position.y + 0.5} ${this.el.object3D.position.z}`,
            dur: 200,
            dir: 'alternate',
            loop: 2,
            easing: 'easeOutQuad'
          });
        });
      }
    });

    /* OBJECTS REACT TO PLAYER MOVEMENT */
    AFRAME.registerComponent('react-to-movement', {
      schema: { intensity: {type: 'number', default: 0.03} },
      init: function () {
        this.lastPos = new THREE.Vector3();
      },
      tick: function () {
        const rig = document.querySelector('#rig').object3D;
        const currentPos = rig.position.clone();
        const distance = currentPos.distanceTo(this.lastPos);

        if (distance > 0.001) {
          const offset = (Math.random() - 0.5) * this.data.intensity;
          this.el.object3D.position.x += offset;
          this.el.object3D.rotation.y += offset * 2;
        }

        this.lastPos.copy(currentPos);
      }
    });

    /* FIREFLY GENERATOR */
    AFRAME.registerComponent('firefly', {
      tick: function () {
        const t = performance.now() / 1000;
        this.el.object3D.position.x += Math.sin(t * 2) * 0.005;
        this.el.object3D.position.z += Math.cos(t * 2) * 0.005;
      }
    });

    function spawnFireflies() {
      const container = document.querySelector('#fireflies');
      for (let i = 0; i < 20; i++) {
        const f = document.createElement('a-sphere');
        f.setAttribute('radius', '0.05');
        f.setAttribute('color', '#ffffaa');
        f.setAttribute('material', 'emissive: #ffffaa; emissiveIntensity: 1');
        f.setAttribute('position', `${(Math.random()*10)-5} 1.5 ${(Math.random()*10)-5}`);
        f.setAttribute('firefly', '');
        container.appendChild(f);
      }
    }

    /* MINIMAP ORB FOLLOWS PLAYER */
    AFRAME.registerComponent('minimap-follow', {
      tick: function () {
        const rig = document.querySelector('#rig').object3D.position;
        this.el.object3D.position.set(rig.x, 4, rig.z);
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.clickable').forEach(el => {
        el.setAttribute('click-behavior', '');
      });

      document.querySelectorAll('.react').forEach(el => {
        el.setAttribute('react-to-movement', 'intensity: 0.03');
      });

      document.querySelector('#minimap').setAttribute('minimap-follow', '');

      spawnFireflies();
    });
  </script>

</a-scene>
</body>
</html>
