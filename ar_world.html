<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AR testing by Stenoip Company</title>
<style>
  html, body { margin:0; height:100%; background:#111; color:#fff; font-family:sans-serif; }
  #ui { position:fixed; bottom:20px; left:50%; transform:translateX(-50%); }
  button { padding:12px 16px; border:none; border-radius:8px; background:#28a745; color:#fff; font-size:16px; }
  canvas { width:100%; height:100%; display:block; }
</style>
</head>
<body>
<canvas id="glcanvas"></canvas>
<div id="ui"><button id="start">Start AR</button></div>

<script>
var xrSession = null;
var gl = null;
var xrRefSpace = null;
var canvas = document.getElementById('glcanvas');
var startBtn = document.getElementById('start');

/* Shader helpers */
function createShader(gl, type, src) {
  var s = gl.createShader(type);
  gl.shaderSource(s, src);
  gl.compileShader(s);
  return s;
}
function createProgram(gl, vsSrc, fsSrc) {
  var vs = createShader(gl, gl.VERTEX_SHADER, vsSrc);
  var fs = createShader(gl, gl.FRAGMENT_SHADER, fsSrc);
  var p = gl.createProgram();
  gl.attachShader(p, vs); gl.attachShader(p, fs); gl.linkProgram(p);
  return p;
}

/* Cube geometry */
var cubeVerts = new Float32Array([
  -0.1,-0.1, 0.1, 1,0,0,   0.1,-0.1, 0.1, 0,1,0,   0.1, 0.1, 0.1, 0,0,1,  -0.1, 0.1, 0.1, 1,1,0,
  -0.1,-0.1,-0.1, 1,0,1,   0.1,-0.1,-0.1, 0,1,1,   0.1, 0.1,-0.1, 1,1,1,  -0.1, 0.1,-0.1, 0.5,0.5,0.5
]);
var cubeIdx = new Uint16Array([
  0,1,2, 0,2,3, 4,6,5, 4,7,6, 0,3,7, 0,7,4, 1,5,6, 1,6,2, 3,2,6, 3,6,7, 0,4,5, 0,5,1
]);

var progCube, aPosLoc, aColLoc, uProjLoc, uViewLoc, uModelLoc;
var cubeVBO, cubeCBO, cubeIBO;

/* Shaders */
var vsSrc = `
attribute vec3 aPos;
attribute vec3 aCol;
uniform mat4 uProj;
uniform mat4 uView;
uniform mat4 uModel;
varying vec3 vCol;
void main(){
  gl_Position = uProj * uView * uModel * vec4(aPos,1.0);
  vCol = aCol;
}`;
var fsSrc = `
precision mediump float;
varying vec3 vCol;
void main(){ gl_FragColor = vec4(vCol,1.0); }`;

function setupWebGL() {
  gl = canvas.getContext('webgl', { xrCompatible:true });
  xrSession.updateRenderState({ baseLayer: new XRWebGLLayer(xrSession, gl) });

  progCube = createProgram(gl, vsSrc, fsSrc);
  aPosLoc = gl.getAttribLocation(progCube, 'aPos');
  aColLoc = gl.getAttribLocation(progCube, 'aCol');
  uProjLoc = gl.getUniformLocation(progCube, 'uProj');
  uViewLoc = gl.getUniformLocation(progCube, 'uView');
  uModelLoc = gl.getUniformLocation(progCube, 'uModel');

  cubeVBO = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, cubeVBO);
  gl.bufferData(gl.ARRAY_BUFFER, cubeVerts, gl.STATIC_DRAW);

  var cols = new Float32Array(8*3);
  for (var i=0;i<8;i++){ cols[i*3]=cubeVerts[i*6+3]; cols[i*3+1]=cubeVerts[i*6+4]; cols[i*3+2]=cubeVerts[i*6+5]; }
  cubeCBO = gl.createBuffer();
  gl.bindBuffer(gl.ARRAY_BUFFER, cubeCBO);
  gl.bufferData(gl.ARRAY_BUFFER, cols, gl.STATIC_DRAW);

  cubeIBO = gl.createBuffer();
  gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, cubeIBO);
  gl.bufferData(gl.ELEMENT_ARRAY_BUFFER, cubeIdx, gl.STATIC_DRAW);
}

startBtn.onclick = function(){
  navigator.xr.requestSession('immersive-ar', { requiredFeatures:['local-floor'] }).then(function(session){
    xrSession = session;
    setupWebGL();
    xrSession.requestReferenceSpace('local-floor').then(function(ref){
      xrRefSpace = ref;
      xrSession.requestAnimationFrame(onXRFrame);
    });
  });
};

function onXRFrame(time, frame) {
  xrSession.requestAnimationFrame(onXRFrame);
  var baseLayer = xrSession.renderState.baseLayer;
  gl.bindFramebuffer(gl.FRAMEBUFFER, baseLayer.framebuffer);

  var pose = frame.getViewerPose(xrRefSpace);
  if (!pose) return;

  gl.clearColor(0,0,0,0);
  gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
  gl.enable(gl.DEPTH_TEST);

  for (var i=0;i<pose.views.length;i++) {
    var view = pose.views[i];
    var vp = baseLayer.getViewport(view);
    gl.viewport(vp.x, vp.y, vp.width, vp.height);

    gl.useProgram(progCube);
    gl.uniformMatrix4fv(uProjLoc, false, view.projectionMatrix);
    gl.uniformMatrix4fv(uViewLoc, false, view.transform.inverse.matrix);

    // Model matrix: cube floating 0.5m in front of camera
    var model = mat4Identity();
    model[12] = 0; model[13] = 0; model[14] = -0.5;
    gl.uniformMatrix4fv(uModelLoc, false, model);

    gl.bindBuffer(gl.ARRAY_BUFFER, cubeVBO);
    gl.enableVertexAttribArray(aPosLoc);
    gl.vertexAttribPointer(aPosLoc, 3, gl.FLOAT, false, 24, 0);

    gl.bindBuffer(gl.ARRAY_BUFFER, cubeCBO);
    gl.enableVertexAttribArray(aColLoc);
    gl.vertexAttribPointer(aColLoc, 3, gl.FLOAT, false, 0, 0);

    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER, cubeIBO);
    gl.drawElements(gl.TRIANGLES, cubeIdx.length, gl.UNSIGNED_SHORT, 0);
  }
}

function mat4Identity(){ return new Float32Array([1,0,0,0, 0,1,0,0, 0,0,1,0, 0,0,0,1]); }
</script>
</body>
</html>
