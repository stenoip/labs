<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Simple WebXR AR</title>
<style>
    body { margin: 0; overflow: hidden; }
    #enter-ar {
        position: absolute;
        bottom: 20px; left: 50%;
        transform: translateX(-50%);
        padding: 12px 20px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 18px;
    }
</style>
</head>
<body>

<button id="enter-ar">Enter AR</button>

<script>
// --- Setup scene ---
var scene = new THREE.Scene();
var camera = new THREE.PerspectiveCamera(70, window.innerWidth/window.innerHeight, 0.01, 20);
var renderer = new THREE.WebGLRenderer({ alpha: true, antialias: true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.xr.enabled = true;
document.body.appendChild(renderer.domElement);

// --- Add cube ---
var geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
var material = new THREE.MeshStandardMaterial({ color: 0xff5533 });
var cube = new THREE.Mesh(geometry, material);
cube.visible = false;
scene.add(cube);

// --- Light ---
var light = new THREE.HemisphereLight(0xffffff, 0x444444, 1);
scene.add(light);

// --- Hit test variables ---
var hitTestSource = null;
var hitTestSourceRequested = false;

// --- AR Session ---
document.getElementById("enter-ar").onclick = function () {
    navigator.xr.requestSession("immersive-ar", {
        requiredFeatures: ["hit-test", "dom-overlay"],
        domOverlay: { root: document.body }
    }).then(startAR);
};

function startAR(session) {
    renderer.xr.setSession(session);
    session.addEventListener("end", function () {
        hitTestSource = null;
        hitTestSourceRequested = false;
    });

    renderer.setAnimationLoop(render);
}

// --- Render loop ---
function render(timestamp, frame) {
    if (frame) {
        var referenceSpace = renderer.xr.getReferenceSpace();
        var session = frame.session;

        if (!hitTestSourceRequested) {
            session.requestReferenceSpace("viewer").then(function (viewerSpace) {
                session.requestHitTestSource({ space: viewerSpace }).then(function (source) {
                    hitTestSource = source;
                });
            });
            hitTestSourceRequested = true;
        }

        if (hitTestSource) {
            var hitTestResults = frame.getHitTestResults(hitTestSource);
            if (hitTestResults.length > 0) {
                var pose = hitTestResults[0].getPose(referenceSpace);

                cube.visible = true;
                cube.position.set(
                    pose.transform.position.x,
                    pose.transform.position.y,
                    pose.transform.position.z
                );

                cube.quaternion.set(
                    pose.transform.orientation.x,
                    pose.transform.orientation.y,
                    pose.transform.orientation.z,
                    pose.transform.orientation.w
                );
            }
        }
    }

    renderer.render(scene, camera);
}
</script>

<!-- THREE.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/three@0.162.0/build/three.min.js"></script>

</body>
</html>
